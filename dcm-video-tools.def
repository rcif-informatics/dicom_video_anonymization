
Bootstrap: docker
From: ubuntu:22.04

%labels
    Maintainer "hodgem@wustl.edu"
    Purpose    "DICOM anonymization (mask) + lossless video + optional lossless re-compress via GDCM"

%help
Usage:
  apptainer exec --bind "$PWD":/work dcm-video-tools.sif \
    dicom_video_anonymization -i /work/input -o /work/output -n 8

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    # Make venv Python default for the runtime:
    export PATH=/opt/venv/bin:/opt/app:$PATH

%files
    bin/dicom_video_anonymization.sh /opt/app/dicom_video_anonymization

%post
    set -eux
    export DEBIAN_FRONTEND=noninteractive

    # Enable Universe (needed on Jammy)
    apt-get update
    apt-get install -y --no-install-recommends software-properties-common ca-certificates
    add-apt-repository -y universe
    apt-get update

    # OS packages
    apt-get install -y --no-install-recommends \
        bash coreutils findutils grep sed gawk procps file jq \
        python3 python3-venv python3-pip python3-dev \
        ffmpeg dcmtk \
        libgdcm3.0 libcharls2 libopenjp2-7 libjpeg-turbo8 \
        libgdcm-tools

    # Create venv and install Python deps there
    python3 -m venv /opt/venv
    /opt/venv/bin/pip install --no-cache-dir --upgrade pip
    /opt/venv/bin/pip install --no-cache-dir \
        numpy pydicom "pylibjpeg[all]"

    # Tools should be on PATH at build-time too:
    export PATH=/opt/venv/bin:/opt/app:$PATH

    chmod 0755 /opt/app/dicom_video_anonymization
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%test
    set -eux
    test -x /opt/app/dicom_video_anonymization
    dcmdump --version | head -n1
    gdcmconv --version | head -n1
    ffmpeg -version | head -n1
    # Verify we are using venv python and have numpy/pydicom/pylibjpeg
    python -c "import sys, numpy, pydicom, pylibjpeg; print(sys.executable); print('numpy', numpy.__version__); print('pydicom', pydicom.__version__); print('pylibjpeg', pylibjpeg.__version__)"

%runscript
    cd /work 2>/dev/null || true
    exec /opt/app/dicom_video_anonymization "$@"

